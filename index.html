I'll enhance your food barcode scanner to be fully accessible, theme-adaptive, and include comprehensive settings. Here's the improved version:

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
  <title>Food Barcode ‚Üí Word Doc</title>
  <meta name="theme-color" content="#0f172a" />
  <script src="https://cdn.jsdelivr.net/npm/docx@9.5.1/build/index.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --gap: 16px;
      --radius: 16px;
      --radius-sm: 12px;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --transition: all 0.2s ease;
    }

    /* Light theme (default) */
    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --border-light: #cbd5e1;
    }

    /* Dark theme */
    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border: #334155;
      --border-light: #475569;
    }

    /* Auto theme - follows system preference */
    @media (prefers-color-scheme: dark) {
      [data-theme="auto"] {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border: #334155;
        --border-light: #475569;
      }
    }

    @media (prefers-color-scheme: light) {
      [data-theme="auto"] {
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #e2e8f0;
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --border-light: #cbd5e1;
      }
    }

    /* High contrast mode */
    @media (prefers-contrast: high) {
      :root {
        --border: currentColor;
        --border-light: currentColor;
      }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    * { 
      box-sizing: border-box; 
    }
    
    html, body {
      margin: 0;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.6;
      scroll-behavior: smooth;
      transition: var(--transition);
    }

    /* Focus styles for accessibility */
    *:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Skip link for screen readers */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: var(--primary);
      color: white;
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 1000;
    }

    .skip-link:focus {
      top: 6px;
    }

    /* Header */
    header {
      padding: 24px var(--gap);
      background: var(--bg-secondary);
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Settings button */
    .settings-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .settings-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-light);
    }

    /* Layout */
    main {
      padding: var(--gap);
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .card:hover {
      border-color: var(--border-light);
      box-shadow: var(--shadow-lg);
    }

    .row {
      display: flex;
      gap: var(--gap);
      flex-wrap: wrap;
      align-items: center;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Typography */
    h2 {
      margin: 0 0 16px 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .success { color: var(--success); }
    .warn { color: var(--warning); }
    .error { color: var(--error); }

    /* Buttons */
    button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 12px 20px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-height: 44px;
      font-family: inherit;
    }

    button:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button.secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    button.secondary:hover:not(:disabled) {
      background: var(--border-light);
    }

    button.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    button.ghost:hover:not(:disabled) {
      background: var(--bg-tertiary);
      border-color: var(--border-light);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Form Elements */
    input, select, textarea {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      width: 100%;
      font-size: 0.875rem;
      transition: var(--transition);
      min-height: 44px;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    /* Pills and Badges */
    .pill {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--bg-primary);
      color: var(--text-secondary);
      transition: var(--transition);
    }

    .pill:hover {
      border-color: var(--border-light);
      background: var(--bg-tertiary);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      font-weight: 500;
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--text-secondary);
    }

    /* Scanner */
    #reader {
      width: 100%;
      min-height: 320px;
      background: var(--bg-primary);
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      position: relative;
      transition: var(--transition);
    }

    #reader:hover {
      border-color: var(--border-light);
    }

    /* Progress Bars */
    .progress-container {
      flex: 1;
      min-width: 200px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .progress-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .progress-value {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .bar {
      height: 8px;
      background: var(--bg-primary);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .bar > span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #8b5cf6);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 999px;
    }

    /* List Items */
    .list-item {
      border-top: 1px solid var(--border);
      padding-top: 16px;
      margin-top: 16px;
      transition: var(--transition);
    }

    .list-item:hover {
      background: var(--bg-primary);
      margin: 16px -12px 0 -12px;
      padding: 16px 12px;
      border-radius: var(--radius-sm);
      border-top: 1px solid transparent;
    }

    /* Toast */
    #toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 16px 20px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-xl);
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      font-weight: 500;
      max-width: 400px;
    }

    #toast.show {
      opacity: 1;
      bottom: 32px;
      pointer-events: auto;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s ease;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      width: min(600px, 92vw);
      max-height: 90vh;
      overflow-y: auto;
      padding: 32px;
      box-shadow: var(--shadow-xl);
      animation: slideUp 0.3s ease;
    }

    .modal h3 {
      margin: 0 0 16px 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Grid */
    .grid {
      display: grid;
      gap: 16px;
    }

    @media(min-width: 768px) {
      .grid-cols-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .grid-cols-3 {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Settings specific styles */
    .settings-section {
      border-bottom: 1px solid var(--border);
      padding-bottom: 20px;
      margin-bottom: 20px;
    }

    .settings-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
    }

    .setting-description {
      flex: 1;
      margin-right: 16px;
    }

    .setting-control {
      min-width: 120px;
    }

    /* Theme selector */
    .theme-selector {
      display: flex;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 4px;
      background: var(--bg-primary);
    }

    .theme-option {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: calc(var(--radius-sm) - 4px);
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.875rem;
    }

    .theme-option.active {
      background: var(--primary);
      color: white;
    }

    /* Responsive */
    @media(max-width: 768px) {
      header {
        padding: 16px var(--gap);
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      h1 {
        font-size: 1.25rem;
        text-align: center;
      }
      
      .header-controls {
        justify-content: center;
      }
      
      .card {
        padding: 20px;
      }
      
      .row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .row.keep-row {
        flex-direction: row;
        align-items: center;
      }

      .setting-item {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .setting-description {
        margin-right: 0;
      }
    }

    /* Product Image */
    .product-image {
      width: 100%;
      max-height: 240px;
      object-fit: contain;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-primary);
      transition: var(--transition);
    }

    .product-image:hover {
      border-color: var(--border-light);
      transform: scale(1.02);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .tabs button {
      min-height: 40px;
      padding: 8px 16px;
      font-size: 0.875rem;
    }

    /* Footer */
    footer {
      margin-top: 40px;
      padding: 24px 0;
      color: var(--text-muted);
      text-align: center;
      border-top: 1px solid var(--border);
    }

    /* Loading States */
    .loading {
      position: relative;
      overflow: hidden;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    /* Status indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-indicator::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-indicator.success::before {
      background: var(--success);
    }

    .status-indicator.warning::before {
      background: var(--warning);
    }

    .status-indicator.error::before {
      background: var(--error);
    }

    /* Range input styling */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: var(--primary);
      border-radius: 50%;
      cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: var(--primary);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    /* Switch/Toggle styling */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--bg-tertiary);
      transition: var(--transition);
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: var(--transition);
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }
  </style>
</head>
<body data-theme="auto">
  <a href="#main" class="skip-link">Skip to main content</a>
  
  <header>
    <h1>üçé Food Barcode ‚Üí Word Doc</h1>
    <div class="header-controls">
      <button class="settings-btn" id="settingsBtn" aria-label="Open settings">
        ‚öôÔ∏è Settings
      </button>
    </div>
  </header>

  <main id="main" class="stack" aria-live="polite">
    <!-- Targets & today progress -->
    <section class="card stack" aria-label="Daily Targets">
      <div class="row keep-row" style="justify-content: space-between; align-items: center;">
        <h2>üìä Today's Targets & Progress</h2>
        <button id="editGoalsBtn" class="ghost" style="min-height: 36px; padding: 8px 12px;">
          ‚úèÔ∏è Edit Goals
        </button>
      </div>
      <div id="targets" class="row" style="gap:12px;flex-wrap:wrap;"></div>
      <div class="stack">
        <div class="row">
          <div class="progress-container">
            <div class="progress-header">
              <span class="progress-label">Calories</span>
              <span id="calTxt" class="progress-value">0 / 0</span>
            </div>
            <div class="bar"><span id="calBar"></span></div>
          </div>
          <div class="progress-container">
            <div class="progress-header">
              <span class="progress-label">Protein (g)</span>
              <span id="proTxt" class="progress-value">0 / 0</span>
            </div>
            <div class="bar"><span id="proBar"></span></div>
          </div>
        </div>
        <div class="row">
          <div class="progress-container">
            <div class="progress-header">
              <span class="progress-label">Fat (g)</span>
              <span id="fatTxt" class="progress-value">0 / 0</span>
            </div>
            <div class="bar"><span id="fatBar"></span></div>
          </div>
          <div class="progress-container">
            <div class="progress-header">
              <span class="progress-label">Carbs (g)</span>
              <span id="carbTxt" class="progress-value">0 / 0</span>
            </div>
            <div class="bar"><span id="carbBar"></span></div>
          </div>
        </div>
      </div>
      <div id="goalHint" class="muted">üí° Set your goals to track your daily nutrition progress.</div>
    </section>

    <!-- Scanner -->
    <section class="card stack" aria-label="Scanner">
      <div class="row keep-row" style="justify-content:space-between;">
        <div class="muted">üì± Use camera, file upload, or manual entry</div>
        <div id="modeBadge" class="badge">Scanner: Ready</div>
      </div>

      <div class="tabs" role="tablist" aria-label="Scan mode">
        <button id="startCam" class="ghost">üì∑ Start Camera</button>
        <button id="flipCam" class="ghost" disabled>üîÑ Flip</button>
        <button id="stopCam" class="ghost" disabled>‚èπÔ∏è Stop</button>
      </div>

      <div id="reader" role="region" aria-label="Camera or file barcode scanner"></div>

      <div class="stack">
        <input id="fileInput" type="file" accept="image/*" aria-label="Choose image file to scan" />
        <div class="row">
          <button id="fileDecode" class="secondary">üìÅ Decode from Image</button>
        </div>
      </div>

      <!-- Lite mode -->
      <div id="liteMode" class="stack" style="display:none;">
        <div class="muted">‚ö†Ô∏è Scanner library failed. Using <strong>Lite mode</strong> (file uploads only).</div>
        <input id="liteFile" type="file" accept="image/*" aria-label="Choose image file for lite mode" />
        <div class="row"><button id="liteDecodeBtn" class="secondary">üìÅ Decode from Image</button></div>
      </div>

      <div class="row">
        <div class="stack" style="flex:1; min-width: 220px;">
          <label for="manual">‚úèÔ∏è Or type a barcode manually</label>
          <div class="row">
            <input id="manual" inputmode="numeric" pattern="[0-9]*" placeholder="e.g. 737628064502" aria-label="Enter barcode manually" />
            <button id="manualGo" class="secondary">üîç Lookup</button>
          </div>
        </div>

        <div class="stack" style="flex:1; min-width: 220px;">
          <label for="proxyToggle">üåê CORS helper (if needed)</label>
          <div class="row">
            <select id="proxyToggle" aria-label="Select CORS proxy option">
              <option value="none">Direct (default)</option>
              <option value="allorigins">Use proxy</option>
            </select>
            <button id="clearResults" class="secondary">üóëÔ∏è Clear</button>
          </div>
        </div>
      </div>
      <div id="status" class="status-indicator muted" role="status" aria-live="polite">Ready to scan</div>
    </section>

    <!-- Latest -->
    <section class="card stack" aria-label="Latest scan result">
      <h2>üîç Latest Product</h2>
      <div id="product-details" class="stack">
        <div class="muted">Scan a barcode to see product details here.</div>
      </div>
      <div class="row">
        <button id="addToList" disabled>‚ûï Add to Document List</button>
      </div>
    </section>

    <!-- Queue -->
    <section class="card stack" aria-label="Document queue">
      <h2>üìã Items to Export</h2>
      <div id="queue" class="stack muted">Nothing added yet.</div>
      <div class="row">
        <button id="exportDocx" disabled>üìÑ Export Word (.docx)</button>
        <button id="removeLast" class="secondary" disabled>‚ùå Remove Last</button>
      </div>
    </section>

    <footer>
      <div class="muted">
        üìä Data from <strong>Open Food Facts</strong> (community-maintained) ‚Ä¢ üîí Scanning runs on your device
      </div>
    </footer>
  </main>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="assertive"></div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <h3>‚öôÔ∏è Settings</h3>
      
      <!-- Appearance Settings -->
      <div class="settings-section">
        <h4 style="margin: 0 0 16px 0; color: var(--text-primary);">üé® Appearance</h4>
        
        <div class="setting-item">
          <div class="setting-description">
            <div style="font-weight: 500;">Theme</div>
            <div class="muted">Choose your preferred color scheme</div>
          </div>
          <div class="setting-control">
            <div class="theme-selector">
              <button class="theme-option" data-theme="light">‚òÄÔ∏è Light</button>
              <button class="theme-option active" data-theme="auto">üåì Auto</button>
              <button class="theme-option" data-theme="dark">üåô Dark</button>
            </div>
          </div>
        </div>

        <div class="setting-item">
          <div class="setting-description">
            <div style="font-weight: 500;">Font Size</div>
            <div class="muted">Adjust text size for better readability</div>
          </div>
          <div class="setting-control">
            <select id="fontSizeSelect" aria-label="Select font size">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Scanning Settings -->
      <div class="settings-section">
        <h4 style="margin: 0 0 16px 0; color: var(--text-primary);">üì± Scanning</h4>
        
        <div class="setting-item">
          <div class="setting-description">
            <div style="font-weight: 500;">Auto-scan delay</div>
            <div class="muted">Prevent duplicate scans (seconds)</div>
          </div>
          <div class="setting-control">
            <input type="range" id="scanDelayRange" min="1" max="10" value="2.5" step="0.5" aria-label="Scan delay in seconds">
            <div class="muted" style="text-align: center; margin-top: 4px;">
              <span id="scanDelayValue">2.5s</span>
            </div>
          </div>
        </div>

        <div class="setting-item">
          <div class="setting-description">
            <div style="font-weight: 500;">Vibration feedback</div>
            <div class="muted">Vibrate on successful scan</div>
          </div>
          <div class="setting-control">
            <label class="switch">
              <input type="checkbox" id="vibrationToggle" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="setting-item">
          <div class="setting-description">
            <div style="font-weight: 500;">Sound feedback</div>
            <div class="muted">Play sound on successful scan</div>
          </div>
          <div class="setting-control">
            <label class="switch">
              <input type="checkbox" id="soundToggle">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>

      <!-- Data Settings -->
      <div class="settings-section">
        <h4 style="margin: 0 0 16px 0; color: var(--text-primary);">üíæ Data</h4>
        
        <div class="setting-item">
          <div class="setting-description">
            <div style="font-weight: 500;">Auto-save progress</div>
            <div class="muted">Automatically save your daily progress</div>
          </div>
          <div class="setting-control">
            <label class="switch">
              <input type="checkbox" id="autoSaveToggle" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="setting-item">
          <div class="setting-description">
            <div style="font-weight: 500;">Clear data</div>
            <div class="muted">Reset all saved data and progress</div>
          </div>
          <div class="setting-control">
            <button id="clearDataBtn" class="secondary" style="min-height: 36px;">üóëÔ∏è Clear All Data</button>
          </div>
        </div>
      </div>

      <!-- Export Settings -->
      <div class="settings-section">
        <h4 style="margin: 0 0 16px 0; color: var(--text-primary);">üìÑ Export</h4>
        
        <div class="setting-item">
          <div class="setting-description">
            <div style="font-weight: 500;">Include images in export</div>
            <div class="muted">Add product images to Word document</div>
          </div>
          <div class="setting-control">
            <label class="switch">
              <input type="checkbox" id="includeImagesToggle" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="setting-item">
          <div class="setting-description">
            <div style="font-weight: 500;">Export format</div>
            <div class="muted">Choose document format</div>
          </div>
          <div class="setting-control">
            <select id="exportFormatSelect" aria-label="Select export format">
              <option value="docx">Word (.docx)</option>
              <option value="pdf">PDF (coming soon)</option>
              <option value="json">JSON Data</option>
            </select>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top: 24px;">
        <button id="saveSettingsBtn">‚úÖ Save Settings</button>
        <button id="closeSettingsBtn" class="secondary">‚ùå Close</button>
      </div>
    </div>
  </div>

  <!-- Edit Goals Modal -->
  <div id="editGoalsModal" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <h3>üéØ Edit Your Goals</h3>
      <div class="muted" style="margin-bottom: 20px;">Customize your daily nutrition targets</div>
      
      <div class="grid grid-cols-2">
        <div class="stack">
          <label for="editCalories">Daily Calories</label>
          <input id="editCalories" type="number" min="800" max="5000" step="50" placeholder="e.g. 2000">
        </div>
        <div class="stack">
          <label for="editProtein">Protein (g)</label>
          <input id="editProtein" type="number" min="20" max="300" step="5" placeholder="e.g. 150">
        </div>
        <div class="stack">
          <label for="editFat">Fat (g)</label>
          <input id="editFat" type="number" min="20" max="200" step="5" placeholder="e.g. 65">
        </div>
        <div class="stack">
          <label for="editCarbs">Carbs (g)</label>
          <input id="editCarbs" type="number" min="50" max="500" step="10" placeholder="e.g. 250">
        </div>
      </div>

      <div class="muted" style="margin: 16px 0;">
        üí° Or use the calculator based on your weight and goals:
      </div>

      <div class="grid grid-cols-2">
        <div class="stack">
          <label for="calcWeight">Current Weight (kg)</label>
          <input id="calcWeight" type="number" min="30" max="300" step="0.1" placeholder="e.g. 75">
        </div>
        <div class="stack">
          <label for="calcGoalWeight">Goal Weight (kg)</label>
          <input id="calcGoalWeight" type="number" min="30" max="300" step="0.1" placeholder="e.g. 70">
        </div>
      </div>

      <div class="row" style="margin-top: 16px;">
        <button id="calculateGoalsBtn" class="secondary">üßÆ Calculate from Weight</button>
      </div>

      <div class="row" style="margin-top: 24px;">
        <button id="saveGoalsBtn">‚úÖ Save Goals</button>
        <button id="cancelGoalsBtn" class="secondary">‚ùå Cancel</button>
      </div>
      <div id="goalsMsg" class="muted" style="margin-top: 12px;"></div>
    </div>
  </div>

  <!-- Onboarding Modal -->
  <div id="onboard" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <h3>üéØ Welcome! Set Your Goals</h3>
      <div class="muted" style="margin-bottom: 20px;">Help us calculate your daily nutrition targets</div>
      <div class="grid grid-cols-2">
        <div class="stack">
          <label for="obWeight">Current Weight (kg)</label>
          <input id="obWeight" type="number" min="30" max="300" step="0.1" placeholder="e.g. 75">
        </div>
        <div class="stack">
          <label for="obGoalWeight">Goal Weight (kg)</label>
          <input id="obGoalWeight" type="number" min="30" max="300" step="0.1" placeholder="e.g. 70">
        </div>
      </div>
      <div class="row" style="margin-top:20px;">
        <button id="obSave">‚úÖ Save & Set Goals</button>
        <button id="obSkip" class="secondary">‚è≠Ô∏è Skip for Now</button>
      </div>
      <div id="obMsg" class="muted">We'll estimate calories and macros automatically based on your goals.</div>
    </div>
  </div>

  <script>
    /***** State *****/
    const state = {
      lastDecoded: null, 
      lastTime: 0,
      currentProduct: null, 
      queue: [],
      html5Qrcode: null, 
      html5Loaded: false, 
      camFacing: 'environment',
      goals: { calories: 0, proteinG: 0, fatG: 0, carbsG: 0 },
      today: { calories: 0, proteinG: 0, fatG: 0, carbsG: 0 },
      settings: {
        theme: 'auto',
        fontSize: 'medium',
        scanDelay: 2.5,
        vibration: true,
        sound: false,
        autoSave: true,
        includeImages: true,
        exportFormat: 'docx'
      }
    };

    /***** DOM refs *****/
    const $ = (id) => document.getElementById(id);
    const statusEl = $('status'), detailsEl = $('product-details'), queueEl = $('queue');
    const addBtn = $('addToList'), exportBtn = $('exportDocx'), removeBtn = $('removeLast');
    const modeBadge = $('modeBadge'), toastEl = $('toast');
    const calBar = $('calBar'), proBar = $('proBar'), fatBar = $('fatBar'), carbBar = $('carbBar');
    const calTxt = $('calTxt'), proTxt = $('proTxt'), fatTxt = $('fatTxt'), carbTxt = $('carbTxt'), targetsWrap = $('targets'), goalHint = $('goalHint');

    /***** Settings Management *****/
    function applySettings() {
      // Apply theme
      document.body.setAttribute('data-theme', state.settings.theme);
      
      // Apply font size
      const fontSizes = {
        small: '14px',
        medium: '16px',
        large: '18px'
      };
      document.documentElement.style.fontSize = fontSizes[state.settings.fontSize];
      
      // Update theme selector
      document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === state.settings.theme);
      });
      
      // Update form controls
      $('fontSizeSelect').value = state.settings.fontSize;
      $('scanDelayRange').value = state.settings.scanDelay;
      $('scanDelayValue').textContent = state.settings.scanDelay + 's';
      $('vibrationToggle').checked = state.settings.vibration;
      $('soundToggle').checked = state.settings.sound;
      $('autoSaveToggle').checked = state.settings.autoSave;
      $('includeImagesToggle').checked = state.settings.includeImages;
      $('exportFormatSelect').value = state.settings.exportFormat;
    }

    function saveSettings() {
      saveLocal('settings', state.settings);
      applySettings();
      toast('‚öôÔ∏è Settings saved successfully!');
    }

    /***** UI helpers *****/
    function setStatus(msg, cls="muted"){ 
      statusEl.className = `status-indicator ${cls}`; 
      statusEl.textContent = msg; 
    }
    
    function toast(msg){ 
      toastEl.textContent = msg; 
      toastEl.classList.add('show'); 
      
      // Vibration feedback
      if (state.settings.vibration && navigator.vibrate) {
        try { navigator.vibrate([40]); } catch {}
      }
      
      // Sound feedback (if implemented)
      if (state.settings.sound) {
        // Could add audio feedback here
      }
      
      setTimeout(() => toastEl.classList.remove('show'), 3000); 
    }
    
    function fmt(v){ return (v ?? "").toString().trim(); }
    function asList(v){ if(!v) return ""; if(Array.isArray(v)) return v.filter(Boolean).join(", "); return String(v); }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function pct(n,d){ if(!d) return 0; return clamp(Math.round((n/d)*100), 0, 100); }

    /***** OFF API helpers *****/
    function offUrlFor(barcode){
      const proxy = $('proxyToggle').value;
      const endpoint = `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`;
      return proxy === 'allorigins' ? `https://api.allorigins.win/raw?url=${encodeURIComponent(endpoint)}` : endpoint;
    }

    async function fetchProduct(barcode){
      setStatus(`üîç Looking up ${barcode}...`);
      const res = await fetch(offUrlFor(barcode), { mode:'cors' }).catch(err => ({ ok:false, error:err }));
      if (!res || !res.ok) throw new Error('Network or CORS error while contacting Open Food Facts.');
      const json = await res.json();
      if (json.status !== 1 || !json.product) throw new Error('Product not found in Open Food Facts.');
      return normalizeProduct(json.product);
    }

    function normalizeProduct(p){
      const n = p.nutriments || {};
      const kcal100 = n['energy-kcal_100g'] ?? n['energy_100g'] ?? null;
      return {
        code: fmt(p.code || p._id),
        name: fmt(p.product_name || p.generic_name || 'Unknown'),
        brands: fmt(p.brands), quantity: fmt(p.quantity),
        categories: fmt(p.categories), ingredients_text: fmt(p.ingredients_text),
        allergens: fmt(p.allergens || asList(p.allergens_tags)),
        nutriscore: fmt(p.nutriscore_grade || p.nutrition_grades),
        nova: fmt(p.nova_groups || p.nova_group), ecoscore: fmt(p.ecoscore_grade),
        url: fmt(p.url || `https://world.openfoodfacts.org/product/${fmt(p.code)}`),
        image: fmt(p.image_front_url || p.image_url),
        per100: {
          kcal: kcal100 != null ? Number(kcal100) : null,
          fat: n['fat_100g'] ?? null,
          sat: n['saturated-fat_100g'] ?? null,
          carbs: n['carbohydrates_100g'] ?? null,
          sugars: n['sugars_100g'] ?? null,
          fiber: n['fiber_100g'] ?? null,
          protein: n['proteins_100g'] ?? null,
          salt: n['salt_100g'] ?? null,
          sodium_mg: n['sodium_100g'] ? Math.round(n['sodium_100g']*1000) : null
        },
        scannedAt: new Date().toISOString()
      };
    }

    /***** Renderers *****/
    function renderProduct(p){
      detailsEl.innerHTML = '';
      if(!p){
        detailsEl.innerHTML = '<div class="muted">Scan a barcode to see product details here.</div>';
        addBtn.disabled = true; return;
      }
      const wrap = document.createElement('div');
      wrap.className = 'stack';
      const nutrPills = [
        ['Energy (kcal/100g)', p.per100.kcal],
        ['Fat (g/100g)', p.per100.fat],
        ['Saturated fat', p.per100.sat],
        ['Carbohydrates', p.per100.carbs],
        ['Sugars', p.per100.sugars],
        ['Fiber', p.per100.fiber],
        ['Proteins', p.per100.protein],
        ['Salt (g/100g)', p.per100.salt],
        ['Sodium (mg/100g)', p.per100.sodium_mg]
      ].map(([k,v])=> `<div class="pill">${k}: ${v==null?'‚Äî':v}</div>`).join('');
      
      wrap.innerHTML = `
        <div class="row keep-row" style="justify-content:space-between;">
          <div>
            <div style="font-size:1.25rem;font-weight:700;margin-bottom:4px;">${p.name || 'Unknown'}${p.brands ? ' ‚Äî ' + p.brands : ''}</div>
            <div class="muted">üìä Barcode: ${p.code} ‚Ä¢ üì¶ ${p.quantity || '‚Äî'}</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            ${p.nutriscore ? `<span class="pill" style="background:var(--success);color:white;">Nutri-Score: ${p.nutriscore.toUpperCase()}</span>` : ''}
            ${p.nova ? `<span class="pill">NOVA: ${p.nova}</span>` : ''}
            ${p.ecoscore ? `<span class="pill" style="background:var(--success);color:white;">Eco-Score: ${p.ecoscore.toUpperCase()}</span>` : ''}
          </div>
        </div>
        ${p.image && state.settings.includeImages ? `<img alt="Product image for ${p.name}" src="${p.image}" class="product-image" />` : ''}
        <div><strong>ü•ó Ingredients:</strong> ${p.ingredients_text || '<span class="muted">‚Äî</span>'}</div>
        <div><strong>‚ö†Ô∏è Allergens:</strong> ${p.allergens || '<span class="muted">‚Äî</span>'}</div>
        <div class="stack">
          <strong>üìä Nutrition (per 100g):</strong>
          <div class="row" style="flex-wrap:wrap;">${nutrPills}</div>
        </div>
        <div class="muted">üìñ Source: <a href="${p.url}" target="_blank" rel="noopener" style="color:var(--primary);">Open Food Facts</a></div>`;
      detailsEl.appendChild(wrap);
      addBtn.disabled = false;
    }

    function renderQueue(){
      if (!state.queue.length){
        queueEl.innerHTML = '<div class="muted">üìù Nothing added yet. Scan some products to get started!</div>'; 
        exportBtn.disabled = true; removeBtn.disabled = true; return;
      }
      exportBtn.disabled = false; removeBtn.disabled = false;
      queueEl.innerHTML = state.queue.map((p,i)=>`
        <div class="list-item">
          <div style="font-weight:600;margin-bottom:4px;">${i+1}. ${p.name || 'Unknown'} ${p.brands ? '‚Äî ' + p.brands : ''}</div>
          <div class="muted">üìä ${p.code} ‚Ä¢ üì¶ ${p.quantity || '‚Äî'} ‚Ä¢ ‚öñÔ∏è ${p.amountG ?? '‚Äî'} g ‚Ä¢ üïí ${new Date(p.scannedAt).toLocaleString()}</div>
          <div class="muted">‚ûï Adds: ${fmtAdds(p.adds)}</div>
        </div>`).join('');
    }
    
    function fmtAdds(a){ 
      if(!a) return '‚Äî'; 
      return `${a.kcal} kcal, P ${a.proteinG}g, F ${a.fatG}g, C ${a.carbsG}g`; 
    }

    function renderTargets(){
      const g = state.goals, t = state.today;
      targetsWrap.innerHTML = `
        <span class="pill">üéØ Calories: <strong>${g.calories||0}</strong></span>
        <span class="pill">ü•© Protein: <strong>${g.proteinG||0} g</strong></span>
        <span class="pill">üßà Fat: <strong>${g.fatG||0} g</strong></span>
        <span class="pill">üçû Carbs: <strong>${g.carbsG||0} g</strong></span>
      `;
      calBar.style.width = pct(t.calories, g.calories) + '%';
      proBar.style.width = pct(t.proteinG, g.proteinG) + '%';
      fatBar.style.width = pct(t.fatG, g.fatG) + '%';
      carbBar.style.width = pct(t.carbsG, g.carbsG) + '%';
      calTxt.textContent = `${t.calories} / ${g.calories}`;
      proTxt.textContent = `${t.proteinG} / ${g.proteinG}`;
      fatTxt.textContent = `${t.fatG} / ${g.fatG}`;
      carbTxt.textContent = `${t.carbsG} / ${g.carbsG}`;
      goalHint.style.display = g.calories ? 'none' : 'block';
    }

    /***** Goal math from weight + goal weight *****/
    function deriveGoals(currentKg, goalKg){
      const maintain = Math.round(currentKg * 30);
      const diff = goalKg - currentKg;
      const delta = diff === 0 ? 0 : clamp(Math.round(Math.abs(diff) * 10), 200, 600) * Math.sign(diff);
      const calories = clamp(maintain + delta, 800, 5000);

      const proteinG = Math.round(clamp(1.8 * currentKg, 1.0*currentKg, 2.6*currentKg));
      const fatPct = 30;
      const fatCals = Math.round(calories * (fatPct/100));
      const fatG = Math.round(fatCals / 9);
      const carbCals = Math.max(0, calories - (proteinG*4) - fatCals);
      const carbsG = Math.round(carbCals / 4);

      return { calories, proteinG, fatG, carbsG };
    }

    /***** Settings Modal Events *****/
    $('settingsBtn').addEventListener('click', () => {
      $('settingsModal').style.display = 'flex';
    });

    $('closeSettingsBtn').addEventListener('click', () => {
      $('settingsModal').style.display = 'none';
    });

    $('saveSettingsBtn').addEventListener('click', () => {
      // Collect settings from form
      state.settings.fontSize = $('fontSizeSelect').value;
      state.settings.scanDelay = parseFloat($('scanDelayRange').value);
      state.settings.vibration = $('vibrationToggle').checked;
      state.settings.sound = $('soundToggle').checked;
      state.settings.autoSave = $('autoSaveToggle').checked;
      state.settings.includeImages = $('includeImagesToggle').checked;
      state.settings.exportFormat = $('exportFormatSelect').value;
      
      saveSettings();
      $('settingsModal').style.display = 'none';
    });

    // Theme selector
    document.querySelectorAll('.theme-option').forEach(btn => {
      btn.addEventListener('click', () => {
        state.settings.theme = btn.dataset.theme;
        document.querySelectorAll('.theme-option').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.body.setAttribute('data-theme', state.settings.theme);
      });
    });

    // Scan delay range
    $('scanDelayRange').addEventListener('input', (e) => {
      $('scanDelayValue').textContent = e.target.value + 's';
    });

    // Clear data button
    $('clearDataBtn').addEventListener('click', () => {
      if (confirm('‚ö†Ô∏è This will permanently delete all your data including goals, progress, and saved items. Are you sure?')) {
        localStorage.clear();
        location.reload();
      }
    });

    /***** Edit Goals Modal Events *****/
    $('editGoalsBtn').addEventListener('click', () => {
      // Pre-fill current goals
      $('editCalories').value = state.goals.calories || '';
      $('editProtein').value = state.goals.proteinG || '';
      $('editFat').value = state.goals.fatG || '';
      $('editCarbs').value = state.goals.carbsG || '';
      $('editGoalsModal').style.display = 'flex';
    });

    $('cancelGoalsBtn').addEventListener('click', () => {
      $('editGoalsModal').style.display = 'none';
    });

    $('calculateGoalsBtn').addEventListener('click', () => {
      const w = parseFloat($('calcWeight').value);
      const gw = parseFloat($('calcGoalWeight').value);
      const msg = $('goalsMsg');
      
      if (!w || w < 30 || w > 300) {
        msg.textContent = '‚ö†Ô∏è Enter a valid current weight (30‚Äì300kg).';
        return;
      }
      if (!gw || gw < 30 || gw > 300) {
        msg.textContent = '‚ö†Ô∏è Enter a valid goal weight (30‚Äì300kg).';
        return;
      }
      
      const calculated = deriveGoals(w, gw);
      $('editCalories').value = calculated.calories;
      $('editProtein').value = calculated.proteinG;
      $('editFat').value = calculated.fatG;
      $('editCarbs').value = calculated.carbsG;
      
      msg.textContent = '‚úÖ Goals calculated! Review and save if they look good.';
    });

    $('saveGoalsBtn').addEventListener('click', () => {
      const calories = parseInt($('editCalories').value);
      const proteinG = parseInt($('editProtein').value);
      const fatG = parseInt($('editFat').value);
      const carbsG = parseInt($('editCarbs').value);
      const msg = $('goalsMsg');
      
      if (!calories || calories < 800 || calories > 5000) {
        msg.textContent = '‚ö†Ô∏è Enter valid calories (800-5000).';
        return;
      }
      if (!proteinG || proteinG < 20 || proteinG > 300) {
        msg.textContent = '‚ö†Ô∏è Enter valid protein (20-300g).';
        return;
      }
      if (!fatG || fatG < 20 || fatG > 200) {
        msg.textContent = '‚ö†Ô∏è Enter valid fat (20-200g).';
        return;
      }
      if (!carbsG || carbsG < 50 || carbsG > 500) {
        msg.textContent = '‚ö†Ô∏è Enter valid carbs (50-500g).';
        return;
      }
      
      state.goals = { calories, proteinG, fatG, carbsG };
      saveLocal('goals', state.goals);
      renderTargets();
      $('editGoalsModal').style.display = 'none';
      toast('üéØ Goals updated successfully!');
    });

    /***** Onboarding modal *****/
    const ob = $('onboard'), obW = $('obWeight'), obGW = $('obGoalWeight'), obMsg = $('obMsg');
    $('obSave').addEventListener('click', ()=>{
      const w = parseFloat(obW.value), gw = parseFloat(obGW.value);
      if (!w || w<30 || w>300) return obMsg.textContent='‚ö†Ô∏è Enter a valid current weight (30‚Äì300kg).';
      if (!gw || gw<30 || gw>300) return obMsg.textContent='‚ö†Ô∏è Enter a valid goal weight (30‚Äì300kg).';
      state.goals = deriveGoals(w, gw);
      saveLocal('goals', state.goals);
      ob.style.display='none';
      renderTargets();
      toast('üéØ Goals set successfully!');
    });
    $('obSkip').addEventListener('click', ()=>{ ob.style.display='none'; });

    function maybeShowOnboarding(){
      const saved = loadLocal('goals');
      if (saved && saved.calories){ state.goals = saved; renderTargets(); return; }
      ob.style.display = 'flex';
    }

    /***** Tracking helpers *****/
    function calcAdds(per100, grams){
      if (!per100) return null;
      const ratio = grams/100;
      const kcal = per100.kcal!=null ? Math.round(per100.kcal * ratio) : 0;
      const proteinG = per100.protein!=null ? Math.round((+per100.protein) * ratio) : 0;
      const fatG = per100.fat!=null ? Math.round((+per100.fat) * ratio) : 0;
      const carbsG = per100.carbs!=null ? Math.round((+per100.carbs) * ratio) : 0;
      return { kcal, proteinG, fatG, carbsG };
    }

    function addToToday(adds){
      if (!adds) return;
      state.today.calories += adds.kcal;
      state.today.proteinG += adds.proteinG;
      state.today.fatG += adds.fatG;
      state.today.carbsG += adds.carbsG;
      state.today.calories = Math.round(state.today.calories);
      state.today.proteinG = Math.round(state.today.proteinG);
      state.today.fatG = Math.round(state.today.fatG);
      state.today.carbsG = Math.round(state.today.carbsG);
      renderTargets();
      if (state.settings.autoSave) {
        saveLocal('today', state.today);
      }
    }

    /***** Events *****/
    $('manualGo').addEventListener('click', lookupManual);
    $('clearResults').addEventListener('click', () => { 
      state.currentProduct=null; 
      renderProduct(null); 
      setStatus('‚ú® Cleared results.'); 
    });
    $('proxyToggle').addEventListener('change', ()=> setStatus('üåê Proxy setting updated.'));
    $('addToList').addEventListener('click', onAddToList);
    $('removeLast').addEventListener('click', ()=> { 
      state.queue.pop(); 
      renderQueue(); 
      setStatus('‚ùå Removed last item.'); 
      if (state.settings.autoSave) {
        saveLocal('queue', state.queue); 
      }
    });
    $('exportDocx').addEventListener('click', exportDocx);

    async function lookupManual(){
      const digits = ($('manual').value || '').replace(/\D/g,'');
      if (!digits) return setStatus('‚ö†Ô∏è Enter a barcode to look up.','warning');
      if (!/^\d{8}$|^\d{12}$|^\d{13}$/.test(digits)) return setStatus('‚ö†Ô∏è Enter a valid EAN/UPC code.','warning');
      try{
        const p = await fetchProduct(digits); 
        state.currentProduct=p; 
        renderProduct(p);
        setStatus(`‚úÖ Found product for ${digits}.`,'success'); 
        toast(`üéâ Found: ${p.name || 'Product'} (${digits})`);
      }catch(err){ 
        setStatus(`‚ùå ${err.message}`,'error'); 
        state.currentProduct=null; 
        renderProduct(null); 
      }
    }

    async function onAddToList(){
      if (!state.currentProduct) return;
      const grams = await promptAmount();
      if (grams == null) return;
      const adds = calcAdds(state.currentProduct.per100, grams);
      const item = JSON.parse(JSON.stringify(state.currentProduct));
      item.amountG = grams;
      item.adds = adds;
      state.queue.push(item);
      addToToday(adds);
      renderQueue();
      setStatus('‚úÖ Added to document list & totals.', 'success');
      toast(`üìù Logged ${grams}g ¬∑ +${adds.kcal} kcal`);
      if (state.settings.autoSave) {
        saveLocal('queue', state.queue);
      }
    }

    function promptAmount(){
      return new Promise((resolve)=>{
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
          <h3>‚öñÔ∏è How much did you have?</h3>
          <div class="grid grid-cols-2">
            <div class="stack">
              <label for="amtG">Amount (grams)</label>
              <input id="amtG" type="number" min="1" max="2000" step="1" placeholder="e.g. 50" autofocus>
            </div>
            <div class="stack muted" style="justify-content:flex-end;">
              <div>üí° Most labels show nutrition per 100g. We'll scale it for your portion.</div>
            </div>
          </div>
          <div class="row" style="margin-top:20px;">
            <button id="amtOk">‚úÖ Add to List</button>
            <button id="amtCancel" class="secondary">‚ùå Cancel</button>
          </div>`;
        backdrop.appendChild(modal);
        document.body.appendChild(backdrop);
        const amtG = modal.querySelector('#amtG');
        modal.querySelector('#amtOk').addEventListener('click', ()=>{
          const v = parseInt(amtG.value, 10);
          if (!v || v<=0) return;
          cleanup(); resolve(v);
        });
        modal.querySelector('#amtCancel').addEventListener('click', ()=>{ cleanup(); resolve(null); });
        backdrop.addEventListener('click', (e) => {
          if (e.target === backdrop) { cleanup(); resolve(null); }
        });
        function cleanup(){ backdrop.remove(); }
        amtG.focus();
      });
    }

    /***** DOCX export *****/
    async function exportDocx(){
      if (!state.queue.length) return;
      if (!window.docx) return setStatus('‚ùå Export library failed to load.','error');
      
      setStatus('üìÑ Generating document...', 'success');
      
      const { Document,Packer,Paragraph,HeadingLevel,Table,TableRow,TableCell,WidthType,TextRun,ExternalHyperlink } = window.docx;
      const sections = [
        new Paragraph({ text:'üçé Food Barcode Log', heading:HeadingLevel.TITLE }),
        new Paragraph({ text:`üìÖ Generated: ${new Date().toLocaleString()}` }),
        new Paragraph({ text:`üìä Daily totals: ${state.today.calories} kcal ‚Ä¢ P ${state.today.proteinG}g ‚Ä¢ F ${state.today.fatG}g ‚Ä¢ C ${state.today.carbsG}g` })
      ];
      
      for (const p of state.queue){
        sections.push(new Paragraph({ text:'' }));
        sections.push(new Paragraph({ text:`${p.name}${p.brands?' ‚Äî '+p.brands:''}`, heading:HeadingLevel.HEADING_1 }));
        sections.push(new Table({
          width:{ size:100, type:WidthType.PERCENTAGE },
          rows:[
            ['Barcode', p.code], ['Quantity', p.quantity||''], ['Amount eaten (g)', p.amountG ?? ''],
            ['Nutritional contribution', p.adds ? `${p.adds.kcal} kcal ‚Ä¢ P ${p.adds.proteinG}g ‚Ä¢ F ${p.adds.fatG}g ‚Ä¢ C ${p.adds.carbsG}g` : ''],
            ['Categories', p.categories||''], ['Allergens', p.allergens||''],
            ['Nutri-Score', (p.nutriscore||'').toUpperCase()], ['NOVA group', p.nova||''], ['Eco-Score', (p.ecoscore||'').toUpperCase()],
            ['Scanned at', new Date(p.scannedAt).toLocaleString()]
          ].map(([k,v])=> new TableRow({ children:[
            new TableCell({ children:[ new Paragraph({ text:k }) ] }),
            new TableCell({ children:[ new Paragraph({ text:(v??'').toString() }) ] })
          ]}))
        }));
        sections.push(new Paragraph({ text:'' }));
        sections.push(new Paragraph({ text:'Ingredients', heading:HeadingLevel.HEADING_2 }));
        sections.push(new Paragraph({ text: p.ingredients_text || '‚Äî' }));
        sections.push(new Paragraph({ text:'' }));
        sections.push(new Paragraph({ text:'Nutrition per 100g', heading:HeadingLevel.HEADING_2 }));
        const perRows = Object.entries({
          'Energy (kcal/100g)': p.per100.kcal, 'Fat (g/100g)': p.per100.fat, 'Saturated fat (g/100g)': p.per100.sat,
          'Carbohydrates (g/100g)': p.per100.carbs, 'Sugars (g/100g)': p.per100.sugars, 'Fiber (g/100g)': p.per100.fiber,
          'Proteins (g/100g)': p.per100.protein, 'Salt (g/100g)': p.per100.salt, 'Sodium (mg/100g)': p.per100.sodium_mg
        });
        sections.push(new Table({
          width:{ size:100, type:WidthType.PERCENTAGE },
          rows: perRows.map(([k,v])=> new TableRow({ children:[
            new TableCell({ children:[ new Paragraph({ text:k }) ] }),
            new TableCell({ children:[ new Paragraph({ text: v==null ? '‚Äî' : String(v) }) ] })
          ]}))
        }));
        sections.push(new Paragraph({ text:'' }));
        sections.push(new Paragraph({ children:[
          new TextRun({ text:'Source: ' }),
          new ExternalHyperlink({ children:[ new TextRun({ text:p.url, underline:{} }) ], link:p.url })
        ]}));
      }
      
      const doc = new Document({ sections:[{ children:sections }] });
      const blob = await Packer.toBlob(doc);
      const fname = `Food-Log-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.docx`;
      const a = document.createElement('a'); 
      a.href = URL.createObjectURL(blob); 
      a.download = fname;
      document.body.appendChild(a); 
      a.click(); 
      URL.revokeObjectURL(a.href); 
      a.remove();
      setStatus(`‚úÖ Exported ${state.queue.length} item(s) to ${fname}.`, 'success');
      toast(`üìÑ Document exported successfully!`);
    }

    /***** Scanner libraries with fallbacks *****/
    const CDN_TRIES = [
      'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js',
      'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js',
      'https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js'
    ];
    
    function loadScript(src){ 
      return new Promise((resolve,reject)=>{ 
        const s=document.createElement('script'); 
        s.src=src; s.async=true; s.onload=resolve; s.onerror=reject; 
        document.head.appendChild(s); 
      }); 
    }
    
    async function loadHtml5WithFallbacks(){ 
      for (const url of CDN_TRIES){ 
        try{ 
          await loadScript(url); 
          if (window.Html5Qrcode) return true; 
        }catch(e){} 
      } 
      return false; 
    }

    async function ensureZXing(){
      if (window.ZXing) return true;
      try{ 
        await loadScript('https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0'); 
        return !!window.ZXing; 
      }catch(e){ 
        return false; 
      }
    }

    /***** Camera controls *****/
    const startBtn = $('startCam'), stopBtn = $('stopCam'), flipBtn = $('flipCam');
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    flipBtn.addEventListener('click', async ()=>{
      if (!state.html5Qrcode) return;
      state.camFacing = (state.camFacing === 'environment') ? 'user' : 'environment';
      await restartCamera();
    });

    async function startCamera(){
      if (!state.html5Loaded){
        setStatus('üì± Loading camera scanner...', 'success');
        const ok = await loadHtml5WithFallbacks();
        state.html5Loaded = ok;
      }
      if (!state.html5Loaded || !window.Html5Qrcode){
        modeBadge.textContent = 'Scanner: Lite mode';
        $('liteMode').style.display = 'flex';
        setStatus('‚ö†Ô∏è Camera unavailable. Use file upload.', 'warning');
        return;
      }
      if (!state.html5Qrcode) state.html5Qrcode = new Html5Qrcode("reader");
      modeBadge.textContent = 'Scanner: Camera Active';
      const config = {
        fps: 12,
        qrbox: { width: 320, height: 140 },
        formatsToSupport: [
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E
        ],
        experimentalFeatures: { useBarCodeDetectorIfSupported: true }
      };
      const constraints = { facingMode: { exact: state.camFacing } };
      try{
        await state.html5Qrcode.start(constraints, config, onScanSuccess, ()=>{});
      }catch(_){
        try{ 
          await state.html5Qrcode.start({ facingMode: state.camFacing }, config, onScanSuccess, ()=>{}); 
        }catch(e){ 
          setStatus('‚ùå Camera failed. Check permissions.', 'error'); 
          return; 
        }
      }
      startBtn.disabled = true; stopBtn.disabled = false; flipBtn.disabled = false;
      setStatus(`üì∑ Camera started (${state.camFacing}).`, 'success');
    }
    
    async function stopCamera(){ 
      if (!state.html5Qrcode) return; 
      try{ await state.html5Qrcode.stop(); }catch{} 
      try{ await state.html5Qrcode.clear(); }catch{} 
      startBtn.disabled = false; stopBtn.disabled = true; flipBtn.disabled = true;
      modeBadge.textContent = 'Scanner: Ready';
      setStatus('üì∑ Camera stopped.', 'success');
    }
    
    async function restartCamera(){ 
      await stopCamera(); 
      await startCamera(); 
    }

    async function onScanSuccess(decodedText){
      const now = Date.now();
      if (decodedText === state.lastDecoded && now - state.lastTime < (state.settings.scanDelay * 1000)) return;
      state.lastDecoded = decodedText; state.lastTime = now;
      const digits = decodedText.replace(/\D/g,'');
      if (!/^\d{8}$|^\d{12}$|^\d{13}$/.test(digits)) return setStatus(`‚ö†Ô∏è "${decodedText}" not a valid barcode.`,'warning');
      try{
        const p = await fetchProduct(digits); 
        state.currentProduct=p; 
        renderProduct(p);
        setStatus(`‚úÖ Found product for ${digits}.`,'success'); 
        toast(`üéâ Scanned: ${p.name || 'Product'}`);
      }catch(err){ 
        setStatus(`‚ùå ${err.message}`,'error'); 
        state.currentProduct=null; 
        renderProduct(null); 
      }
    }

    // File decode
    $('fileDecode').addEventListener('click', async ()=>{
      const f = $('fileInput').files?.[0];
      if (!f) return setStatus('‚ö†Ô∏è Choose an image first.','warning');
      await decodeFromImageFile(f);
    });
    
    $('liteDecodeBtn')?.addEventListener('click', async ()=>{
      const f = $('liteFile').files?.[0];
      if (!f) return setStatus('‚ö†Ô∏è Choose an image first.','warning');
      await decodeFromImageFile(f);
    });

    async function decodeFromImageFile(file){
      const hasZX = await ensureZXing();
      if (!hasZX){ 
        setStatus('‚ùå Could not load decoder library.','error'); 
        return; 
      }
      const codeReader = new ZXing.BrowserBarcodeReader();
      const url = URL.createObjectURL(file);
      setStatus('üîç Decoding image...', 'success');
      try{
        const res = await codeReader.decodeFromImageUrl(url);
        const decoded = res?.text;
        if (!decoded) return setStatus('‚ö†Ô∏è No barcode found in image.','warning');
        const digits = decoded.replace(/\D/g,'');
        if (!/^\d{8}$|^\d{12}$|^\d{13}$/.test(digits)) return setStatus(`‚ö†Ô∏è "${decoded}" not a valid barcode.`, 'warning');
        const p = await fetchProduct(digits); 
        state.currentProduct=p; 
        renderProduct(p);
        setStatus(`‚úÖ Found product for ${digits}.`, 'success'); 
        toast(`üéâ Found: ${p.name || 'Product'}`);
      }catch(e){ 
        setStatus('‚ùå Failed to decode image.', 'error'); 
      }finally{ 
        URL.revokeObjectURL(url); 
        codeReader.reset(); 
      }
    }

    /***** Local storage *****/
    function saveLocal(k, v){ 
      try{ 
        localStorage.setItem('fbw_'+k, JSON.stringify(v)); 
      }catch{} 
    }
    
    function loadLocal(k){ 
      try{ 
        const v=localStorage.getItem('fbw_'+k); 
        return v?JSON.parse(v):null; 
      }catch{ 
        return null; 
      } 
    }
    
    function loadPersisted(){
      const g = loadLocal('goals'); if (g) state.goals = g;
      const t = loadLocal('today'); if (t) state.today = t;
      const q = loadLocal('queue'); if (q) state.queue = q;
      const s = loadLocal('settings'); if (s) state.settings = {...state.settings, ...s};
      renderTargets(); renderQueue(); renderProduct(null);
      applySettings();
    }

    /***** Boot *****/
    function boot(){
      loadPersisted();
      if (!(location.protocol === 'https:' || location.hostname === 'localhost')) {
        setStatus('üí° Use HTTPS for camera access. File upload works anywhere.', 'warning');
      } else {
        setStatus('‚ú® Ready to scan barcodes!', 'success');
      }
      if (!state.goals || !state.goals.calories) maybeShowOnboarding();
    }
    
    // Close modals when clicking backdrop
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-backdrop')) {
        e.target.style.display = 'none';
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Close any open modal
        document.querySelectorAll('.modal-backdrop').forEach(modal => {
          if (modal.style.display !== 'none') {
            modal.style.display = 'none';
          }
        });
      }
    });
    
    window.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
